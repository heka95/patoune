---
layout: single
title:  "Pr√©sentation de Microsoft Retina"
date:   2024-03-25 23:03:19 +0100
tags:
    - azure
header:
  teaser: /assets/images/overview_retina_256_256.jpg
  og_image: /assets/images/overview_retina_256_256.jpg
---

Durant ma participation √† la KubeCon, j'ai eu l'occasion de pouvoir participer √† la *Azure day with Kubernetes*.
Un nouvel outil en cours de d√©veloppement a √©t√© pr√©sent√© : `retina`

## Qu'est-ce que Retina ?

Retina est un outil permettant de faire une surveillance du r√©seau et des services AKS. L'objectif de Retina est de r√©colter de la t√©l√©m√©trie personnalisable et de la pousser sur diff√©rents services (Promotheus, via un PV etc...).

## Fonctionnement

Retina propose plusieurs modes de r√©colte d'information:

### *Via la CLI* : 

Dans ce mode de capture, le lancement d'une commande via la cli Retina permet la cr√©ation d'un job Kubernetes qui va effectuer une capture en se basant sur un node selector. La dur√©e par d√©faut est d'une minute mais il est possible de le configurer via la commande de la CLI via `--no-wait=true` pour que √ßa tourn en continue. D'autres options sont possibles comme capper la taille du fichier de sortie pour la capture, de faire du filtrage par **\[ip\]:\[port\]** ou encore via une DNS query **udp port 53**.

*Exemple de capture avec une dur√©e de 10 minutes et une taille de fichier de sortie max √† 100MB*
{% highlight powershell %}
kubectl retina capture create --host-path /mnt/capture \ 
--namespace capture --node-selectors "kubernetes.io/os=linux" \ 
--duration=10m --max-size=100
{% endhighlight %}

*Schema de fonctionnement via la CLI:*
![retina-cli-schema](https://retina.sh/assets/images/capture-architecture-without-operator-8b30bdccc806411433443aee233e699a.png)

### *Via le d√©ploiement d'une CRD (Custom Resource Definition)*: 

Dans ce mode de fonctionnement, le d√©ploiement d'une ressource kube *Capture* va permettre de pouvoir avoir un service qui va faire une r√©colte continue.

*Exemple de d√©finition:*
{% highlight yaml %}
apiVersion: retina.sh/v1alpha1
kind: Capture
metadata:
  name: example-capture
spec:
  captureConfiguration:
    captureOption:
      duration: "30s"
      maxCaptureSize: 100
      packetSize: 1500
    captureTarget:
      namespaceSelector:
        matchLabels:
          app: target-app
  outputConfiguration:
    hostPath: /captures
    blobUpload: blob-sas-url
{% endhighlight %}

*Schema de fonctionnement via le d√©ploiement d'une CRD:*
![retina-crd-schema](https://retina.sh/assets/images/capture-architecture-with-operator-2fd7bdbb30046b54d4075aa48de7bf8a.png)

[retina-repo]: https://github.com/microsoft/retina

[cli-schema]: https://retina.sh/assets/images/capture-architecture-without-operator-8b30bdccc806411433443aee233e699a.png

## Que capture Retina ?

Retina propose diff√©rent modes de captures:

- Basic : Rappatriement des mesures agr√©g√©es par Node (cluster / instance) et leurs m√©triques  (Nombre / taille de paquets transmis, Nombre / taille de paquets perdus, informations que retournerais la commande *netstats*)

- Advanced : M√©trique *Basic* avec en plus des donn√©es de contexte (source/destination ip, source/destination namespace, source/destination pod, source/destination workload) et des m√©triques suppl√©mentaires li√© au DNS. Les m√©triques concernant les paquets sont quant √† elles plus d√©taill√©es.

### Des m√©triques param√©trables et extensibles

Toutes ces metriques sont bas√©es sur un syst√®me de plugins qu'il faut d√©finir √† l'installation de Retina. J'ignore pour le moment s'il est possible de pouvoir en ajouter ou en supprimer post-installation mais j'imagine que que cette fonctionnalit√©e sera disponible par la suite.

## Et apr√®s ?

De mon point de vue, je trouve que cet outil permet de combler un d√©faut que l'on rencontrait sur AKS, √† savoir : Le manque de m√©trique. L'outil est actuellement en version *0.0.3* √† l'heure o√π j'√©cris cet article mais il y a une forte communaut√© autour de ce projet et j'imagine qu'il va rapidement prendre de l'ampleur. La possibilit√© d'enrichir les m√©triques avec du contenu personnalisable est d√©j√† pr√©vue et r√©pondra pour beaucoup √† un besoin d'y ajouter ses propres informations. Pour ma part, je ne l'utiliserais pas encore en production car le projet est encore trop immature mais je pense qu'il faut y garder un oeil (ou une r√©tine üòÅ).Ce projet semble en tout cas tr√®s prometteur.

## Sources

- [Site officiel de Retina](https://retina.sh/)
- [Repository GitHub](https://github.com/microsoft/retina)
